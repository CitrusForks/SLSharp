<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>SL#</title>
	<link href="stylesheets/main.css" rel="stylesheet" type="text/css" />
	<link href="stylesheets/csharp.css" rel="stylesheet" type="text/css" />
</head>
<body>

	

<div id="wrapper">
	<div id="header">
		<div id="menu">
		<ul class="nav">
		<li><a href="index.html" class="navfirst">Home</a></li>
		<li><a href="download.html">Download</a></li>
		<li><a href="sample.html">Sample</a></li>
		<li><a href="internals.html" class="current">Internals</a></li>
		<li><a href="links.html">Links</a></li>
		</ul>
		</div>
		<div style="float:right;">
		<a href="http://validator.w3.org/check?uri=referer"><img
	        src="http://www.w3.org/Icons/valid-xhtml10"
       	 	alt="Valid XHTML 1.0 Transitional" height="31" width="88" /></a>
		</div>
		<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
		<input type="hidden" name="cmd" value="_s-xclick" />
		<input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
" />
		<input type="image" src="https://www.paypal.com/en_US/i/btn/btn_donateCC_LG.gif" style="border-style:none;" name="submit" alt="PayPal - The safer, easier way to pay online!" />
		<img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
		</form>

	</div>
	<div id="content">

<h2>This page gives a short overview of the translation process SL# will perform.</h2>
Assume we have implemented a 
<a href="http://http.developer.nvidia.com/GPUGems2/gpugems2_chapter26.html">simplex noise shader</a> 
in <a href="SimplexNoiseShader.cs">SimplexNoiseShader.cs</a>
that is defined as:

<pre class="csharpcode">
<span class="kwrd">public</span> <span class="kwrd">abstract</span> <span class="kwrd">class</span> SimplexNoiseShader: Shaders.Shader
{
    [Uniform] <span class="kwrd">protected</span> <span class="kwrd">abstract</span> Sampler1D PermGradSampler { set; get; }
    [Uniform] <span class="kwrd">protected</span> <span class="kwrd">abstract</span> Sampler2D PermSampler2D { set; get;  }

    [FragmentShader]
    <span class="kwrd">protected</span> vec3 Fade(vec3 t)
    {
        <span class="kwrd">return</span> t * t * t * (t * (t * 6.0f - 15.0f) + 10.0f); <span class="rem">// new curve</span>
    }

    [FragmentShader]
    <span class="kwrd">protected</span> vec4 Perm2D(vec2 p)
    {
        <span class="kwrd">return</span> texture2D(PermSampler2D, p);
    }

    [FragmentShader]
    <span class="kwrd">protected</span> <span class="kwrd">float</span> Gradperm(<span class="kwrd">float</span> x, vec3 p)
    {
        <span class="kwrd">return</span> dot(texture1D(PermGradSampler, x).xyz, p);
    }

    [FragmentShader]
    <span class="kwrd">protected</span> <span class="kwrd">float</span> Inoise(vec3 p)
    {
        vec3 q = mod(floor(p), 256.0f);
        p -= floor(p);
        vec3 f = Fade(p);

        q = q / 256.0f;
        <span class="kwrd">const</span> <span class="kwrd">float</span> one = 1.0f / 256.0f;

        var aa = Perm2D(q.xy) + q.z;
        var zo = <span class="kwrd">new</span> vec2(0.0f, 1.0f);
        <span class="kwrd">return</span> mix(mix(mix(Gradperm(aa.x, p), Gradperm(aa.z, p - zo.yxx), f.x),
                            mix(Gradperm(aa.y, p - zo.xyx), Gradperm(aa.w, p - zo.yyx), f.x),
                            f.y),
                    mix(mix(Gradperm(aa.x + one, p - zo.xxy), Gradperm(aa.z + one, p - zo.yxy), f.x),
                            mix(Gradperm(aa.y + one, p - zo.xyy), Gradperm(aa.w + one, p - zo.yyy), f.x),
                            f.y),
                    f.z);
    }

    [FragmentShader]
    <span class="kwrd">public</span> <span class="kwrd">float</span> FBm(vec3 p, <span class="kwrd">int</span> octaves, <span class="kwrd">float</span> lacunarity, <span class="kwrd">float</span> gain)
    {
        var freq = 1.0f;
        var amp = 1.0f;
        var sum = 0.0f;

        <span class="kwrd">for</span> (var i = 0; i &lt; octaves; i++)
        {
            sum += Inoise(p * freq) * amp;
            freq *= lacunarity;
            amp *= gain;
        }

        <span class="kwrd">return</span> sum;
    }
    ... some non shader related details are ommited here see <a href="SimplexNoiseShader.cs">SimplexNoiseShader.cs</a> for a full implementation ...
}
</pre>

Let's specifically look at the FBm() function as this is the most interesting one due to having a loop.
<p />
The first thing SL# does is fetch the IL of SimplexNoiseShader.FBm which, in our case, looks like this:

<pre class="csharpcode">
0 : ldc.r4 1
5 : stloc.0
6 : ldc.r4 1
11: stloc.1
12: ldc.r4 0
17: stloc.2
18: ldc.i4.0
19: stloc.3
20: br.s 53
22: ldloc.2
23: ldarg.0
24: ldarg.1
25: ldloc.0
26: call vec3 op_Multiply(vec3, Single)
31: call Single Inoise(vec3)
36: ldloc.1
37: mul
38: add
39: stloc.2
40: ldloc.0
41: ldarg.3
42: mul
43: stloc.0
44: ldloc.1
45: ldarg.s Single gain
47: mul
48: stloc.1
49: ldloc.3
50: ldc.i4.1
51: add
52: stloc.3
53: ldloc.3
54: ldarg.2
55: blt.s 22
57: ldloc.2
58: ret
</pre>

The next stage SL# does is reconstruct an expression stream, which will then be translated to GLSL.
The result of this process looks like this:

<pre class="csharpcode">
<span class="kwrd">float</span> M_GeoClip_Shaders_SimplexNoiseShader_FBm(<span class="kwrd">vec3</span> p,<span class="kwrd">int</span> octaves,<span class="kwrd">float</span> lacunarity,<span class="kwrd">float</span> gain)
{
    <span class="kwrd">float</span> _l0;
    <span class="kwrd">float</span> _l1;
    <span class="kwrd">float</span> _l2;
    <span class="kwrd">int</span> _l3;
    <span class="kwrd">float</span> _l4;
    _l0=1.0;
    _l1=1.0;
    _l2=0.0;
    _l3=0;
    <span class="kwrd">while</span> ((octaves&lt;_l3))
    {
        _l2=(_l2+(M_GeoClip_Shaders_SimplexNoiseShader_Inoise((p*_l0))*_l1));
        _l0=(_l0*lacunarity);
        _l1=(_l1*gain);
        _l3=(_l3+1);
    }
    _l4=_l2;
    <span class="kwrd">return</span> _l4;
}
</pre>

Unfortunately, not everything can be reconstructed to the original form.
Most obvious things are that you lose all comments as these won't be compiled
to IL. But you also lose local variable names. For common cases this however
should not be a problem, as you won't export the shaders but consume them just 
within your application/library.
<p />
SL# names all uniforms, varyings, attributes, and function names according to
the class/namespace the shader is defined within. This avoids clashes due to
shared names if you build shader libraries. All calls or accesses to foreign
shaders will be translated properly.
<p />
In release build the default behavior is to obfuscate all names.
The whole shader above translated to GLSL in release build is given below.

<pre class="csharpcode">
#version 120
<span class="kwrd">uniform sampler1D</span> _v23;
<span class="kwrd">uniform sampler2D</span> _v24;
<span class="kwrd">vec3</span> _v25(<span class="kwrd">vec3</span> t);
<span class="kwrd">vec4</span> _v26(<span class="kwrd">vec2</span> p);
<span class="kwrd">float</span> _v27(<span class="kwrd">float</span> x,<span class="kwrd">vec3</span> p);
<span class="kwrd">float</span> _v0(<span class="kwrd">vec3</span> p);

<span class="kwrd">vec3</span> _v25(<span class="kwrd">vec3</span> t)
{
    <span class="kwrd">return</span> (((t*t)*t)*((t*((t*6.0)-15.0))+10.0));
}

<span class="kwrd">vec4</span> _v26(<span class="kwrd">vec2</span> p)
{
    <span class="kwrd">return</span> texture2D(_v24,p);
}

<span class="kwrd">float</span> _v27(<span class="kwrd">float</span> x,<span class="kwrd">vec3</span> p)
{
    <span class="kwrd">return</span> dot(texture1D(_v23,x).xyz,p);
}

<span class="kwrd">float</span> _v0(<span class="kwrd">vec3</span> p)
{
    <span class="kwrd">vec3</span> _l0;
    <span class="kwrd">vec3</span> _l1;
    <span class="kwrd">vec4</span> _l2;
    <span class="kwrd">vec2</span> _l3;
    _l0=mod(floor(p),256.0);
    p=(p-floor(p));
    _l1=_v25(p);
    _l0=(_l0/256.0);
    _l2=(_v26(_l0.xy)+_l0.z);
    _l3=vec2(0.0,1.0);
    return mix(mix(mix(_v27(_l2.x,p),_v27(_l2.z,(p-_l3.yxx)),_l1.x),
           mix(_v27(_l2.y,(p-_l3.xyx)),_v27(_l2.w,(p-_l3.yyx)),_l1.x),_l1.y),
           mix(mix(_v27((_l2.x+0.00390625),(p-_l3.xxy)),_v27((_l2.z+0.00390625),
           (p-_l3.yxy)),_l1.x),mix(_v27((_l2.y+0.00390625),(p-_l3.xyy)),
           _v27((_l2.w+0.00390625),(p-_l3.yyy)),_l1.x),_l1.y),_l1.z);
}

<span class="kwrd">float</span> _v1(<span class="kwrd">vec3</span> _a1,<span class="kwrd">int</span> _a2,float _a3,<span class="kwrd">float</span> _a4)
{
    <span class="kwrd">float</span> _l0;<span class="kwrd">float</span> _l1;<span class="kwrd">float</span> _l2;<span class="kwrd">int</span> _l3;
    _l0=1.0; _l1=1.0; _l2=0.0; _l3=0;
    <span class="kwrd">while</span> ((_l3&lt;_a2))
    {
        _l2=(_l2+(_v0((_a1*_l0))*_l1));
        _l0=(_l0*_a3);
        _l1=(_l1*_a4);
        _l3=(_l3+1);
    }
    <span class="kwrd">return</span> _l2;
}
</pre>




			<div id="footer">
			<a href="download.html">Downloads</a><span>|</span>
			<a href="legal.html">Legal notice</a>
		</div>
	</div>
</div>

</body>
</html>
